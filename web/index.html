<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Rooms</title>
  <style>
    body{font-family:Arial,sans-serif;background:#0b0b0c;color:#f3f4f6;margin:0}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .card{background:#151518;border:1px solid #2b2b31;border-radius:12px;padding:12px;margin-bottom:12px}
    input,textarea,button,select{border-radius:10px;border:1px solid #34343d;background:#111;color:#fff;padding:10px}
    input,textarea,select{width:100%}
    button{cursor:pointer;background:#1f6feb;border:none}
    button.ghost{background:#2a2a31}
    .row{display:flex;gap:8px;align-items:center}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .muted{color:#9ca3af;font-size:12px}
    .msg{padding:8px 10px;border-radius:10px;background:#1f1f25;margin:6px 0}
    .msg .meta{font-size:11px;color:#9ca3af}
    #messages{max-height:50vh;overflow:auto}
    .hidden{display:none}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <h2>Chat Room</h2>

  <div id="lobby" class="card">
    <div class="row" style="justify-content:space-between">
      <strong>Room Lobby</strong>
      <button class="ghost" id="refreshRooms">Refresh</button>
    </div>
    <p class="muted">Buat room public/private, join pakai nama room atau invite code.</p>

    <div class="card">
      <strong>Create Room</strong>
      <div class="grid" style="margin-top:8px">
        <input id="createOwner" placeholder="Nama kamu (owner)" maxlength="40" />
        <input id="createName" placeholder="Nama room" maxlength="60" />
      </div>
      <div class="row" style="margin-top:8px">
        <label class="row"><input id="createPrivate" type="checkbox" style="width:auto"/> Private</label>
        <input id="createPassword" placeholder="Password room (kalau private)" maxlength="100" />
        <button id="createBtn">Create</button>
      </div>
    </div>

    <div class="card">
      <strong>Join Room</strong>
      <div class="grid" style="margin-top:8px">
        <input id="joinName" placeholder="Nama kamu" maxlength="40" />
        <input id="joinIdentifier" placeholder="Nama room / invite code" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="joinPassword" placeholder="Password (kosongkan jika public)" maxlength="100" />
        <button id="joinBtn">Join</button>
      </div>
    </div>

    <div class="card">
      <strong>Available Rooms</strong>
      <div id="rooms"></div>
    </div>
  </div>

  <div id="chat" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <div>
        <strong id="roomTitle"></strong>
        <div class="muted" id="roomMeta"></div>
      </div>
      <div class="row">
        <button id="regenInvite" class="ghost hidden">Regenerate Invite</button>
        <button id="regenPassword" class="ghost hidden">Regenerate Password</button>
        <button id="leaveBtn" class="ghost">Leave</button>
      </div>
    </div>

    <div id="messages"></div>

    <div class="row" style="margin-top:8px">
      <textarea id="message" rows="2" maxlength="500" placeholder="Tulis pesan..."></textarea>
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
const DEFAULT_API_URL = 'https://chatroom-cf-api.badryansah99.workers.dev';
const API = (localStorage.getItem('CHAT_API_URL') || DEFAULT_API_URL).replace(/\/$/, '');

const state = {
  session: JSON.parse(localStorage.getItem('CHAT_SESSION') || 'null'),
  poll: null,
};

const el = (id) => document.getElementById(id);

function saveSession(s){ state.session=s; localStorage.setItem('CHAT_SESSION', JSON.stringify(s)); }
function clearSession(){ state.session=null; localStorage.removeItem('CHAT_SESSION'); }
function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function t(ts){ try{return new Date(ts).toLocaleString()}catch{return ts||''} }

async function api(path, opt={}){
  const res = await fetch(API + path, {headers:{'Content-Type':'application/json'}, ...opt});
  const data = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}

function showLobby(){
  el('chat').classList.add('hidden');
  el('lobby').classList.remove('hidden');
  if(state.poll) clearInterval(state.poll);
}

function showChat(){
  const s = state.session;
  el('lobby').classList.add('hidden');
  el('chat').classList.remove('hidden');
  el('roomTitle').textContent = s.roomName;
  el('roomMeta').textContent = `Invite: ${s.inviteCode} ‚Ä¢ Owner: ${s.ownerName}`;
  el('regenInvite').classList.toggle('hidden', !s.isOwner);
  el('regenPassword').classList.toggle('hidden', !s.isOwner);
  loadMessages();
  if(state.poll) clearInterval(state.poll);
  state.poll = setInterval(loadMessages, 4000);
}

async function loadRooms(){
  const data = await api('/api/rooms');
  const rows = data.rooms || [];
  el('rooms').innerHTML = rows.map(r => `
    <div class="row" style="justify-content:space-between;margin-top:8px;padding:8px;border:1px solid #2b2b31;border-radius:10px">
      <div>
        <div><strong>${esc(r.name)}</strong> ${r.is_private ? 'üîí' : 'üåç'}</div>
        <div class="muted">Invite: ${esc(r.invite_code)} ‚Ä¢ Members: ${r.member_count || 0}</div>
      </div>
      <button class="ghost" onclick="quickJoin('${esc(r.invite_code)}')">Join</button>
    </div>
  `).join('') || '<p class="muted">No rooms yet</p>';
}

async function loadMessages(){
  const s = state.session;
  if(!s) return;
  const data = await api(`/api/messages?roomId=${s.roomId}`);
  const arr = data.messages || [];
  el('messages').innerHTML = arr.map(m => `
    <div class="msg">
      <div><strong>${esc(m.name)}</strong></div>
      <div>${esc(m.message)}</div>
      <div class="meta">${t(m.created_at)}</div>
    </div>
  `).join('');
  el('messages').scrollTop = el('messages').scrollHeight;
}

async function createRoom(){
  try{
    const payload = {
      ownerName: el('createOwner').value.trim(),
      name: el('createName').value.trim(),
      isPrivate: el('createPrivate').checked,
      password: el('createPassword').value.trim(),
    };
    const data = await api('/api/rooms/create', {method:'POST', body: JSON.stringify(payload)});
    saveSession({
      roomId: data.roomId,
      roomName: data.roomName,
      inviteCode: data.inviteCode,
      ownerName: data.ownerName,
      memberName: payload.ownerName,
      memberToken: data.memberToken,
      isOwner: true,
    });
    showChat();
    await loadRooms();
  }catch(e){ alert(e.message); }
}

async function joinRoom(identifier){
  try{
    const payload = {
      memberName: el('joinName').value.trim(),
      identifier: identifier || el('joinIdentifier').value.trim(),
      password: el('joinPassword').value.trim(),
    };
    const data = await api('/api/rooms/join', {method:'POST', body: JSON.stringify(payload)});
    saveSession({
      roomId: data.roomId,
      roomName: data.roomName,
      inviteCode: data.inviteCode,
      ownerName: data.ownerName,
      memberName: data.memberName,
      memberToken: data.memberToken,
      isOwner: data.isOwner,
    });
    showChat();
  }catch(e){ alert(e.message); }
}

async function sendMessage(){
  try{
    const s = state.session;
    const message = el('message').value.trim();
    if(!message) return;
    await api('/api/messages', {
      method:'POST',
      body: JSON.stringify({ roomId:s.roomId, name:s.memberName, memberToken:s.memberToken, message })
    });
    el('message').value='';
    loadMessages();
  }catch(e){ alert(e.message); }
}

async function regenInvite(){
  const s = state.session;
  try{
    const data = await api(`/api/rooms/${s.roomId}/regenerate-invite`, {
      method:'POST', body: JSON.stringify({ memberName:s.memberName, memberToken:s.memberToken })
    });
    s.inviteCode = data.inviteCode; saveSession(s); showChat();
    alert('Invite code baru: ' + data.inviteCode);
  }catch(e){ alert(e.message); }
}

async function regenPassword(){
  const s = state.session;
  const p = prompt('Password baru (min 4 karakter):');
  if(!p) return;
  try{
    await api(`/api/rooms/${s.roomId}/regenerate-password`, {
      method:'POST', body: JSON.stringify({ memberName:s.memberName, memberToken:s.memberToken, newPassword:p })
    });
    alert('Password room berhasil diganti.');
  }catch(e){ alert(e.message); }
}

window.quickJoin = async function(code){
  el('joinIdentifier').value = code;
  await joinRoom(code);
}

el('refreshRooms').onclick = loadRooms;
el('createBtn').onclick = createRoom;
el('joinBtn').onclick = () => joinRoom();
el('sendBtn').onclick = sendMessage;
el('leaveBtn').onclick = () => { clearSession(); showLobby(); loadRooms(); };
el('regenInvite').onclick = regenInvite;
el('regenPassword').onclick = regenPassword;
el('message').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

(async () => {
  await loadRooms();
  if(state.session) showChat();
})();
</script>
</body>
</html>
